<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Scajong</title>
        <script src="jquery.js"></script>
        <script type="text/javascript">

            const CellWidth = 30;
            const CellHeight = 20;
            const TileOffset = 5;
            const TileImageWidth = 75;
            const TileImageHeight = 95;

            var showHint = false;
            var showMoveables = false;
			var lastId = -1;
			var tileCounter = 0;
			var numberOfAllTiles = -1;
			var tileImages = new Array();
			var field;
			var setups;
			
			function selectPanel(name) {
				var panels = new Array('fieldPanel', 'setupsPanel', 'scoresPanel', 'scorePanel');
				for (var i=0; i<panels.length; i++) {
					var div = document.getElementById(panels[i]);
					if (panels[i] == name) {
						div.style.display = "inline";
					} else {
						div.style.display = "none";
					}
				}
			}
			
			function checkNotifications() {
				$.getJSON('/notifications.json', processNotifications);
			}
			
			function processNotifications(json) {
				$.each(json['notifications'], function(i, item) {
					if (item.id > lastId) {
						//console.log("not: (", item.id, ", ", item.name, ", ", item.param, ")");
						switch(item.name) {
							case 'UpdateField':
								updateField();
								selectPanel('fieldPanel');
								break;
							case 'ShowScore':
								// TODO: load score (setup from param)
								selectPanel('scorePanel');
								break;
						}
						lastId = item.id;
					}
                });
				setTimeout(checkNotifications, 1000);
			}
			
            function updateField() {
                $.getJSON('/field.json', processFieldData);
            }
            
            function processFieldData(json) {
                field = json;
				redraw();
            }
			
			function redraw() {
				var canvas = document.getElementById('field');
                canvas.width = field['fieldwidth'] * CellWidth;
                canvas.height = field['fieldheight'] * CellHeight;
                var context = canvas.getContext('2d');
                context.fillStyle = "rgb(255, 255, 255)";
                context.fillRect(0, 0, canvas.width, canvas.height);
                $.each(field['tiles'], function(i, item) {
                    drawTile(context, item);
                });
			}
            
            function drawTile(context, tile) {
                var x = tile.x * CellWidth - TileOffset;
                var y = tile.y * CellHeight - TileOffset - TileOffset * tile.z;
                context.drawImage(tileImages['tile'], x, y);
                context.drawImage(tileImages[tile.type], x, y);
                if (showHint && tile.hint)
                    context.drawImage(tileImages['hint'], x, y);
                if (showMoveables && !tile.moveable)
                    context.drawImage(tileImages['disabled'], x, y);
                if (tile.selected)
                    context.drawImage(tileImages['selected'], x, y);
            }
            
            function loadTiles() {
                $.getJSON('/tiles.json', processTilesData);
            }
            
            function processTilesData(json) {
                numberOfAllTiles = json['types'].length;
                var otherImages = new Array();
                otherImages[0] = 'selected';
                otherImages[1] = 'hint';
                otherImages[2] = 'empty';
                otherImages[3] = 'tile';
                otherImages[4] = 'disabled';
                numberOfAllTiles += otherImages.length;
                $.each(json['types'], function(i, item) {
                    tileImages[item.name] = new Image();
                    tileImages[item.name].onload = tileLoaded;
                    tileImages[item.name].src = 'tiles/'  + item.name + '.png';
                });
                $.each(otherImages, function(i, item) {
                    tileImages[item] = new Image();
                    tileImages[item].onload = tileLoaded;
                    tileImages[item].src = 'tiles/'  + item + '.png';
                });
            }
            
            function tileLoaded() {
                tileCounter++;
                if (tileCounter == numberOfAllTiles) {
                    loadSetups();
                }
            }
			
			function loadSetups() {
				$.getJSON('/setups.json', processSetupsData);
			}
            
			function processSetupsData(json) {
				setups = json.setups;
				checkNotifications();
			}
			
            function processAction(json) {
				//alert('done');
            }
            
            function moveablesClick(e) {
                showMoveables = true
				redraw();
                setTimeout(function() { showMoveables = false; redraw(); }, 5000);
                var url = '/action/moveables';
                $.getJSON(url, processAction);
            }
            
            function hintClick(e) {
                showHint = true
				redraw();
                setTimeout(function() { showHint = false; redraw(); }, 1000);
                var url = '/action/hint';
                $.getJSON(url, processAction);
            }
            
			function predictNewModel(tile) {
				var oldTileIndex = -1;
				var newTileIndex = -1;
				for (var i = 0; i < field.tiles.length; i++) {
					if (field.tiles[i].selected == true) {
						oldTileIndex = i;
						field.tiles[i].selected = false;
					}
				}
				for (var i = 0; i < field.tiles.length; i++) {
					if (tile.x == field.tiles[i].x && 
							tile.y == field.tiles[i].y &&
							tile.z == field.tiles[i].z &&
						field.tiles[i].moveable == true) {
						newTileIndex = i;
						field.tiles[i].selected = true;
					}
				}
				if (oldTileIndex != -1 && newTileIndex != -1 && oldTileIndex != newTileIndex &&
						field.tiles[oldTileIndex].type == field.tiles[newTileIndex].type) {
					if (oldTileIndex > newTileIndex) {
						field.tiles.splice(oldTileIndex, 1);
						field.tiles.splice(newTileIndex, 1);
					} else {
						field.tiles.splice(newTileIndex, 1);
						field.tiles.splice(oldTileIndex, 1);
					}
				}
				redraw();
			}
			
            function canvasClick (e) {
                var x = e.pageX - this.offsetLeft;
                var y = e.pageY - this.offsetTop;
                for (var i = field.tiles.length-1; i >= 0; i--) {
                    var tile = field.tiles[i];
					var tx = tile.x * CellWidth - TileOffset;
                    var ty = tile.y * CellHeight - TileOffset - TileOffset * tile.z;
                    if (x > tx && x < (tx + TileImageWidth) && y > ty && y < (ty + TileImageHeight)) {
                        var url = '/action/select_' + tile.x + '_' + tile.y + '_' + tile.z;
                        $.getJSON(url, processAction);
						predictNewModel(tile);
						updateField();
                        return;
                    }
                }
            }
			
			function loadScore(scoreIndex) {
				alert('loadScore: ' + scoreIndex);
			}
			
			function loadSetup(setupIndex) { 
				var url = '/action/creategame_' + setups[setupIndex].id;
                $.getJSON(url, processAction);
			}
			
			function selectMenu(panelName, functionName) {
				selectPanel(panelName); 
				var htmlText = '<ul>';
				for (var i=0; i< setups.length; i++) {
					htmlText += '<li><a onclick="' + functionName + '(' + i + ');" href="#">' + setups[i].name + '</a></li>';
				}
				htmlText += '</ul>';
				$('#' + panelName).html(htmlText);
			} 
			
			function selectSetup() {
				selectMenu('setupsPanel', 'loadSetup');
			}
			
			function selectScore() {
				selectMenu('scoresPanel', 'loadScore');
			}

        </script>
    </head>
    <body onload="loadTiles();">
        <div id="menu">
            <button id="createGameButton" type="button">Create New Game</button>
            <button id="showScoresButton" type="button">Show Highscores</button>
        </div>
        <div id="fieldPanel" style="display:none">
            <canvas id="field"></canvas><br />
            <button id="moveableButton" type="button">Show Moveables (+5 Seconds)</button>
            <button id="hintButton" type="button">Show Hint (+15 Seconds)</button>
        </div>
        <div id="setupsPanel" style="display:none">SETUPS</div>
        <div id="scoresPanel" style="display:none">SCORES</div>
		<div id="scorePanel" style="display:none">SCORE</div>
        <script type="text/javascript">
            $("#createGameButton").click(selectSetup);
			$("#showScoresButton").click(selectScore);
			$("#moveableButton").click(moveablesClick);
            $("#hintButton").click(hintClick);
            $("#field").click(canvasClick);
        </script>
    </body>
</html>